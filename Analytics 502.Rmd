---
title: "Analytics 502"
author: "Avik Roy"
date: "September 30, 2018"
output:
  word_document: default
  pdf_document: default
  html_document: default
classoption: landscape
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,tidy.opts=list(width.cutoff=30),tidy=TRUE)
library(tidyverse)
set.seed(111)
```

# ABSTRACT
_**I am just using this as a scratchpad for noting down ideas. Does not really correlate whith what should go on paper. Please pay more attention to the sections**_ 

Right now the goal is to get a good understanding of the data. AKA exploratory analysis.
Relationships worth checking out:
*Arr Delay ~ Day of the week*
It seems arrival delay is related to day of the week.

Hypothesis Test
H0 : Mean arrival delay on Sat-Evening <= 0
H1 : Mean arival delay on Sat-Evening > 0

There should be a section to check t-test assumptions (n>30, etc, etc)

Net Delay ~ Month
Dep Delay ~ Dep Airport
Arr Delay ~ Arr Airport
Net Delay ~ Airline


Prediction query: What is the chance that a flight will be delayed given.......

#DATA LOADING & MANIPULATION
####Checking out the data

```{r check}
flightData <- read.csv("flights.csv", header = TRUE)
head(flightData)
str(flightData)
summary(flightData)
```

####Modifying the dataset

```{r modify}
flightData <- mutate(flightData, DAY_OF_WEEK = as.factor(DAY_OF_WEEK))
flightData$DAY_OF_WEEK <- ordered(flightData$DAY_OF_WEEK, levels = c("1","2","3","4","5","6","7"))
levels(flightData$DAY_OF_WEEK) <- c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")
```

####Additional modification
Modifying the dataset convert integer time to HH:MM format time
```{r}
flightData <- mutate(flightData, SCHEDULED_DEPARTURE = format(strptime(sprintf("%04d",SCHEDULED_DEPARTURE), format="%H%M"), format = "%H:%M"))
flightData <- mutate(flightData, DEPARTURE_TIME = format(strptime(sprintf("%04d",DEPARTURE_TIME), format="%H%M"), format = "%H:%M"))
```

Modifying the dataset to have, a column for morning to night clasification for _scheduled_ departure time
```{r}
flightData <- mutate(flightData, DEP_TIME_OF_DAY = 
                       ifelse (SCHEDULED_DEPARTURE >= "18:00","Evening",
                       ifelse (SCHEDULED_DEPARTURE >= "12:00","Afternoon",
                       ifelse (SCHEDULED_DEPARTURE >= "06:00","Morning","Night")))
                    )
```

Ordering the factors in Time of day
```{r}
flightData <- mutate(flightData, DEP_TIME_OF_DAY = as.factor(DEP_TIME_OF_DAY))
flightData$DEP_TIME_OF_DAY <- ordered(flightData$DEP_TIME_OF_DAY, levels = c("Morning","Afternoon", "Evening","Night"))
```
#EXPLORATORY DATA ANALYSIS
This section should have more graphs, charts and bits 'n pieces of other small studies. More so to make the report and presentation look 'fuller'. In my next version of this doc, I will add more. But feel free to suggest.

####Plot of arrival delay vs Day of the week + Time of the day
```{r}
groupByDayTime <- group_by(select(flightData, DAY_OF_WEEK, DEP_TIME_OF_DAY, ARRIVAL_DELAY),DAY_OF_WEEK,DEP_TIME_OF_DAY)
groupByDayTime <- groupByDayTime[complete.cases(groupByDayTime),]
delayByDayTime <- summarise(groupByDayTime, AVG_ARR_DELAY = mean(ARRIVAL_DELAY))
ggplot(data = delayByDayTime, aes(x = DEP_TIME_OF_DAY, y = AVG_ARR_DELAY, fill = DAY_OF_WEEK)) + geom_bar(stat = "identity") + guides(fill = FALSE) + facet_wrap(vars(DAY_OF_WEEK),nrow = 1) + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
#INFERENCE

This is to prove that for flights departing on saturday evenings, there is definitely a delay on arrival and it is not a result of sample variance.

####Hypothesis Test
H0 : Mean arrival delay on Sat-Evening <= 0
H1 : Mean arival delay on Sat-Evening > 0

Putting saturday arrival delays in  a vector and then running the above hypothesis tests
```{r hypotest1}
arrdelaySat <- filter(flightData, DAY_OF_WEEK == "Saturday", DEP_TIME_OF_DAY == "Evening")$ARRIVAL_DELAY
summary(arrdelaySat)
test_res <- t.test(arrdelaySat, mu = 0, alternative = "greater")
test_res
```
#THE 'BEST' MODEL

In the last lecture class, the professor taught us a workflow for determoining the 'best' model. I have used the adjusted r squared method. Please use the lecture notes to understand what I did below:

####STEP 1: FULL MODEL (day,time, airline, origin, destination)
```{r step1}
arrDelayModel00 <- lm(ARRIVAL_DELAY ~ DAY_OF_WEEK + DEP_TIME_OF_DAY + AIRLINE + ORIGIN_AIRPORT + DESTINATION_AIRPORT , data = flightData)
summary(arrDelayModel00)$adj.r.squared
```

####STEP 2: 4-Variable MODEL
From the results below it looks like removing any of the variables gives a lower adjusted r-square.
So, **the full model is the best model**
```{r step2, eval = FALSE}
arrDelayModel01 <- lm(ARRIVAL_DELAY ~ DEP_TIME_OF_DAY + AIRLINE + ORIGIN_AIRPORT + DESTINATION_AIRPORT , data = flightData)
print("No DAY_OF_WEEK")
summary(arrDelayModel01)$adj.r.squared
rm(arrDelayModel01)
arrDelayModel02 <- lm(ARRIVAL_DELAY ~ DAY_OF_WEEK + AIRLINE + ORIGIN_AIRPORT + DESTINATION_AIRPORT , data = flightData)
print("No DEP_TIME_OF_DAY")
summary(arrDelayModel02)$adj.r.squared
rm(arrDelayModel02)
arrDelayModel03 <- lm(ARRIVAL_DELAY ~ DAY_OF_WEEK + DEP_TIME_OF_DAY + ORIGIN_AIRPORT + DESTINATION_AIRPORT , data = flightData)
print("No AIRLINE")
summary(arrDelayModel03)$adj.r.squared
rm(arrDelayModel03)
arrDelayModel04 <- lm(ARRIVAL_DELAY ~ DAY_OF_WEEK + DEP_TIME_OF_DAY + AIRLINE + DESTINATION_AIRPORT , data = flightData)
print("No ORIGIN_AIRPORT")
summary(arrDelayModel04)$adj.r.squared
rm(arrDelayModel04)
arrDelayModel05 <- lm(ARRIVAL_DELAY ~ DAY_OF_WEEK + DEP_TIME_OF_DAY + AIRLINE + ORIGIN_AIRPORT, data = flightData)
print("No DESTINATION_AIRPORT")
summary(arrDelayModel05)$adj.r.squared
rm(arrDelayModel05)
```
#PREDICTION

#### Setting prediction Model for day, time, airline, origin & destination (the winning model above)
```{r}
arrDelayModel <- arrDelayModel00
summary(arrDelayModel)
```

#### Predicting for a specific query to demonstrate prediction power
Predicting ARRIVAL_DELAY for a flight departing from Oakland, on a friday afternoon for Baltimore via Spirit Airlines
```{r}
predict(arrDelayModel, data.frame(DAY_OF_WEEK = "Friday", DEP_TIME_OF_DAY = "Afternoon", AIRLINE = "NK", ORIGIN_AIRPORT = "OAK", DESTINATION_AIRPORT = "BWI"))
```
#APPENDIX (All extra bits of analysis that were superceded by the above code)
Plot of arrival delay vs Day of the week

```{r}
groupByDay <- group_by(select(flightData, DAY_OF_WEEK, ARRIVAL_DELAY),DAY_OF_WEEK)
groupByDay <- groupByDay[complete.cases(groupByDay),]
delayByDay <- summarise(groupByDay, AVG_ARR_DELAY = mean(ARRIVAL_DELAY))
ggplot(data = delayByDay, aes(x = DAY_OF_WEEK, y = AVG_ARR_DELAY, fill = DAY_OF_WEEK)) + geom_bar(stat = "identity") + guides(fill = FALSE)
```

####Hypothesis Test
H0 : Mean arrival delay on Sat <= 0
H1 : Mean arival delay > 0

Putting saturday arrival delays in  a vector and then running the above hypothesis tests
```{r hypotest2}
arrdelaySat <- filter(flightData, DAY_OF_WEEK == "Saturday")$ARRIVAL_DELAY
summary(arrdelaySat)
test_res <- t.test(arrdelaySat, mu = 0, alternative = "greater")
test_res
```
